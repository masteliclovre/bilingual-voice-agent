<!doctype html>
<html lang="hr">
  <head>
    <meta charset="utf-8" />
    <title>Vapi Bilingual Preview (Debug)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
      body { margin: 24px; color: #111; }
      h1 { margin: 0 0 16px; font-size: 20px; }
      .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
      .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      label { font-size: 12px; color: #444; margin-bottom: 4px; display: inline-block; }
      input, textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
      textarea { min-height: 120px; }
      .card { border: 1px solid #eee; border-radius: 12px; padding: 16px; background: #fafafa; }
      button { padding: 10px 14px; border: 0; border-radius: 10px; cursor: pointer; font-weight: 600; }
      .primary { background: #111; color: #fff; }
      .secondary { background: #e9ecef; color: #111; }
      .muted { color: #555; font-size: 12px; }
      #log { white-space: pre-wrap; background: #0b1020; color: #d1e9ff; padding: 12px; border-radius: 10px; min-height: 280px; max-height: 65vh; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
      .row-buttons { display: flex; gap: 10px; align-items: center; }
      .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #ddd; background: #fff; }
      .ok { color: #059669; border-color: #059669; }
      .bad { color: #dc2626; border-color: #dc2626; }
    </style>
  </head>
  <body>
    <h1>Vapi Bilingual Preview (Debug)</h1>

    <div class="grid">
      <div class="card">
        <div class="row">
          <div style="flex:1">
            <label>Vapi PUBLIC KEY</label>
            <input id="publicKey" placeholder="pk_live_..." />
          </div>
          <div style="flex:1">
            <label>Assistant ID</label>
            <input id="assistantId" placeholder="asst_..." />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Router WSS URL</label>
            <input id="routerWss" placeholder="wss://<ngrok-id>.ngrok-free.app/router" />
            <div class="muted">Točno onaj URL koji ti daje ngrok (wss) + <code>/router</code></div>
          </div>
          <div style="flex:1">
            <label>Router Secret (opcionalno)</label>
            <input id="routerSecret" placeholder="optional_vapi_secret" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>System prompt</label>
          <textarea id="prompt" placeholder="Odgovaraj istim jezikom kao sugovornik (HR/EN)."></textarea>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>Voice provider</label>
            <select id="voiceProvider">
              <option value="vapi" selected>vapi (built-in)</option>
              <option value="11labs">11labs (requires API key)</option>
              <option value="openai">openai (alloy)</option>
            </select>
          </div>
          <div style="flex:1">
            <label>Voice ID / name</label>
            <input id="voiceId" value="Elliot" />
            <div class="muted" id="voiceHint">For vapi use one of: Elliot, Kylie, Rohan, Lily, Savannah, Hana, Neha, Cole, Harry, Paige, Spencer</div>
          </div>
        </div>

        <div class="row-buttons" style="margin-top:14px">
          <button id="start" class="primary">▶ Start</button>
          <button id="stop"  class="secondary" disabled>■ Stop</button>
          <span id="status" class="pill">idle</span>
          <span id="mic" class="pill">mic: ?</span>
        </div>
      </div>

      <div class="card">
        <label>Debug log</label>
        <div id="log"></div>
      </div>
    </div>

    <script type="module">
      import Vapi from 'https://esm.sh/@vapi-ai/web@^2.3.9';

      // ---------- utils & debug helpers ----------
      const $ = (id) => document.getElementById(id);
      const logEl = $('log');
      const statusEl = $('status');
      const micEl = $('mic');
      const now = () => new Date().toLocaleTimeString();
      const log = (msg) => { logEl.textContent += `[${now()}] ${msg}\n`; logEl.scrollTop = logEl.scrollHeight; };
      const setStatus = (txt, ok=true) => { statusEl.textContent = txt; statusEl.className = 'pill ' + (ok ? 'ok' : 'bad'); };
      const redact = (k, v) => { const key=(k||'').toLowerCase(); if(['secret','apikey','api_key','token','authorization','auth','key'].some(s=>key.includes(s))) return '***'; if(typeof v==='string' && v.startsWith('sk_')) return '***'; return v; };
      const safeStringify = (obj) => { try { return JSON.stringify(obj, redact, 2); } catch { try { return JSON.stringify(obj); } catch { return String(obj); } } };

      // ---------- environment banner ----------
      log(`UA: ${navigator.userAgent}`);
      log(`Page: ${location.href}`);
      log('Preview loaded.');

      // ---------- capture unhandled errors ----------
      window.addEventListener('error', (e) => log(`window.error: ${e.message}`));
      window.addEventListener('unhandledrejection', (e) => log(`unhandledrejection: ${e.reason?.message || e.reason}`));
      document.addEventListener('visibilitychange', () => log(`visibility: ${document.visibilityState}`));
      window.addEventListener('beforeunload', () => log('beforeunload'));

      // ---------- WebRTC debug ----------
      (function wrapRTCPeerConnection(){
        const Orig = window.RTCPeerConnection;
        if (!Orig) return;
        window.RTCPeerConnection = function(...args){
          const pc = new Orig(...args);
          const id = Math.random().toString(36).slice(2,8);
          const dump = () => log(`pc[${id}] states: connection=${pc.connectionState} ice=${pc.iceConnectionState} signaling=${pc.signalingState}`);
          pc.addEventListener('connectionstatechange', dump);
          pc.addEventListener('iceconnectionstatechange', dump);
          pc.addEventListener('signalingstatechange', dump);
          return pc;
        };
      })();

      // ---------- localStorage ----------
      const LS_KEYS = ['publicKey','assistantId','routerWss','routerSecret','prompt','voiceId','voiceProvider'];
      const loadLS = () => { try { LS_KEYS.forEach(k => { const v = localStorage.getItem('vapi_preview_'+k); if (v !== null) $(k).value = v; }); } catch {} };
      const saveLS = () => { if ($('autosave')?.value !== 'on') return; try { LS_KEYS.forEach(k => localStorage.setItem('vapi_preview_'+k, $(k).value)); } catch {} };
      loadLS();

      // ---------- mic/device quick probe ----------
      (async () => {
        try { const s = await navigator.mediaDevices.getUserMedia({ audio: true }); s.getTracks().forEach(t => t.stop()); micEl.textContent='mic: ok'; micEl.className='pill ok';
          const devices = await navigator.mediaDevices.enumerateDevices(); const mics = devices.filter(d => d.kind === 'audioinput').map(d => d.label || '(no label)'); log(`mics: ${mics.join(' | ') || '(none)'}`);
        } catch (e) { micEl.textContent='mic: blocked'; micEl.className='pill bad'; log(`mic error: ${e?.message || e}`); }
      })();

      // ---------- fetch logger for /call/web ----------
      const _fetch = window.fetch.bind(window);
      window.fetch = async (input, init = {}) => {
        const url = typeof input === 'string' ? input : input?.url;
        const isVapi = url && url.includes('/call/web');
        if (isVapi) {
          try {
            const method = (init.method || (typeof input !== 'string' ? input.method : 'POST') || 'POST').toUpperCase();
            let bodyText = ''; if (init.body) { try { bodyText = typeof init.body === 'string' ? init.body : await (init.body?.text?.() ?? Promise.resolve('')); } catch {} } else if (typeof input !== 'string') { try { bodyText = await input.clone().text(); } catch {} }
            let parsed = null; try { parsed = JSON.parse(bodyText); } catch {}
            log(`FETCH → ${method} ${url}`); if (parsed) log('FETCH body (sanitized): ' + safeStringify(parsed));
          } catch (e) { log('FETCH pre-log error: ' + (e?.message || e)); }
        }
        const res = await _fetch(input, init);
        if (isVapi) { let text=''; try { text = await res.clone().text(); } catch {} log(`FETCH ← ${res.status} ${res.statusText} ${url}`); if (!res.ok) log(`FETCH error body: ${text || '(no body)'}`); }
        return res;
      };

      // ---------- Vapi client (single instance) ----------
      let vapi = null, currentPublicKey = null, inCall = false, handlersAttached = false;
      let lastFinalAt = null;

      const vapiVoices = ['Elliot','Kylie','Rohan','Lily','Savannah','Hana','Neha','Cole','Harry','Paige','Spencer'];

      const toggleButtons = () => { $('start').disabled = inCall; $('stop').disabled = !inCall; };
      toggleButtons();

      const onMessage = (m) => {
        if (m.type === 'transcript') {
          const who = m.role || 'unknown';
          const kind = m.transcriptType || 'partial';
          log(`${who} (${kind}): ${m.transcript}`);
          if (kind === 'final') lastFinalAt = performance.now();
        } else if (m.type === 'speech-update') {
          if (m.status === 'started' && lastFinalAt) { log(`TTFB→speech: ${Math.round(performance.now() - lastFinalAt)} ms`); lastFinalAt = null; }
        } else if (m.type === 'status-update' && m.status === 'ended') {
          log(`PIPELINE ENDED: reason=${m.endedReason || '(n/a)'}`);
        } else if (m.type === 'error') {
          log(`SDK message error: ${safeStringify(m)}`);
          setStatus('error', false);
        } else {
          log(`MSG: ${safeStringify(m)}`);
        }
      };

      const attachHandlers = () => {
        if (handlersAttached) return;
        handlersAttached = true;
        vapi.on('call-start', () => { log('--- call started ---'); setStatus('live', true); inCall = true; toggleButtons(); });
        vapi.on('call-end',   () => { log('--- call ended ---');   setStatus('idle', true); inCall = false; toggleButtons(); });
        vapi.on('message', onMessage);
        vapi.on('error', (e) => { log(`SDK error: ${safeStringify(e)}`); setStatus('error', false); });
      };

      // keep helper texts in sync with provider
      const voiceProviderEl = $('voiceProvider');
      const voiceIdEl = $('voiceId');
      const voiceHintEl = $('voiceHint');
      const refreshVoiceHint = () => {
        const p = voiceProviderEl.value;
        if (p === 'vapi') {
          voiceHintEl.textContent = `For vapi use one of: ${vapiVoices.join(', ')}`;
          if (!vapiVoices.includes(voiceIdEl.value)) voiceIdEl.value = 'Elliot';
        } else if (p === 'openai') {
          voiceHintEl.textContent = 'For openai, try: alloy';
          if (!voiceIdEl.value) voiceIdEl.value = 'alloy';
        } else {
          voiceHintEl.textContent = 'For 11labs, paste your ElevenLabs voiceId (uuid).';
          if (voiceIdEl.value === 'Elliot' || voiceIdEl.value === 'alloy') voiceIdEl.value = '';
        }
      };
      voiceProviderEl.addEventListener('change', () => { localStorage.setItem('vapi_preview_voiceProvider', voiceProviderEl.value); refreshVoiceHint(); });
      refreshVoiceHint();

      $('start').onclick = async () => {
        if (inCall) { log('start ignored: already in call'); return; }
        try { saveLS(); } catch {}

        const PUBLIC_KEY   = $('publicKey').value.trim();
        const ASSISTANT_ID = $('assistantId').value.trim();
        const ROUTER_WSS   = $('routerWss').value.trim();
        const SECRET       = $('routerSecret').value.trim();
        const VOICE_ID_RAW = $('voiceId').value.trim();
        const PROVIDER     = $('voiceProvider').value;
        const PROMPT       = $('prompt').value;

        if (!PUBLIC_KEY || !ASSISTANT_ID || !ROUTER_WSS) {
          alert('Ispuni: PUBLIC KEY, ASSISTANT ID i Router WSS URL');
          return;
        }

        if (!vapi || currentPublicKey !== PUBLIC_KEY) {
          vapi = new Vapi(PUBLIC_KEY);
          currentPublicKey = PUBLIC_KEY;
          attachHandlers();
          log('Vapi init');
        }

        try { await vapi.stop(); } catch {}

        // Build a compliant voice block
        let voice;
        if (PROVIDER === 'vapi') {
          const vid = vapiVoices.includes(VOICE_ID_RAW) ? VOICE_ID_RAW : 'Elliot';
          voice = { provider: 'vapi', voiceId: vid };
        } else if (PROVIDER === 'openai') {
          voice = { provider: 'openai', voiceId: VOICE_ID_RAW || 'alloy' };
        } else {
          voice = { provider: '11labs', voiceId: VOICE_ID_RAW }; // must be a valid 11labs id and you need the provider key added in Vapi
        }

        const overrides = {
            model: {
                provider: 'openai',
                model: 'gpt-4o-mini',
                messages: [{ role: 'system', content: PROMPT }]
            },
            voice: {
                provider: 'vapi',
                voiceId: 'Elliot'
            },
            transcriber: {
                provider: "deepgram",
                model: "nova-2",
                language: "multi"
                /*provider: 'custom-transcriber',
                server: { url: ROUTER_WSS },
                ...(SECRET ? { secret: SECRET } : {})*/
            },

            // 👇 NEW: prevent early hangups + start the convo proactively
            silenceTimeoutSeconds: 180,                 // try 120–300
            firstMessageMode: 'assistant-speaks-first', // agent opens
            firstMessage: 'Bok! Kako mogu pomoći? (Možeš pričati hrvatski ili engleski.)',

            // 👇 OPTIONAL: nudge during long pauses instead of ending
            messagePlan: {
                idleMessages: [
                'Još sam tu — želiš nastaviti?',
                'Ako želiš, mogu odmah krenuti s rezervacijom.'
                ],
                idleTimeoutSeconds: 15,         // prompt again after 15s of silence
                idleMessageMaxSpokenCount: 2
            }
        };


        log('ASSISTANT_ID: ' + ASSISTANT_ID);
        log('Overrides (sanitized): ' + safeStringify(overrides));

        try {
          setStatus('connecting…', true);
          $('start').disabled = true;
          $('stop').disabled = false;
          await vapi.start(ASSISTANT_ID, overrides);
        } catch (e) {
          log(`Start error: ${e?.message || e}`);
          setStatus('error', false);
          inCall = false;
          $('start').disabled = false;
          $('stop').disabled = true;
        }
      };

      $('stop').onclick = async () => { try { await vapi?.stop(); } catch {} };

    </script>
  </body>
</html>
